name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip actual release creation)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  PLUGINVAL_VERSION: "1.0.3"
  CLAP_VALIDATOR_VERSION: "0.3.2"
  VALIDATION_STRICTNESS: 5

jobs:
  validate-and-build:
    name: Validate & Build (${{ matrix.os }})
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: ubuntu-latest
            target: linux
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_Linux.zip
            clap_validator_url: https://github.com/free-audio/clap-validator/releases/download/0.3.2/clap-validator-0.3.2-ubuntu-18.04.tar.gz
          - os: windows-latest
            target: windows
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_Windows.zip
            clap_validator_url: https://github.com/free-audio/clap-validator/releases/download/0.3.2/clap-validator-0.3.2-windows.zip
          - os: macos-latest
            target: macos
            pluginval_url: https://github.com/Tracktion/pluginval/releases/download/v1.0.3/pluginval_macOS.zip
            clap_validator_url: https://github.com/free-audio/clap-validator/releases/download/0.3.2/clap-validator-0.3.2-macos-universal.tar.gz
    runs-on: ${{ matrix.os }}
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxcb1-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev libxcb-render-util0-dev libxcb-xkb-dev libxkbcommon-x11-dev libxkbcommon-dev libasound2-dev libxcursor-dev libx11-dev libx11-xcb-dev libjack-dev libxcb-dri2-0-dev libfontconfig1-dev

      - name: Build release
        run: cargo build --release

      - name: Run tests
        run: cargo test --release

      - name: Bundle plugins
        run: cargo xtask bundle ultrawave --release

      # === VALIDATION GATE ===
      - name: Download pluginval (Linux)
        if: runner.os == 'Linux'
        run: |
          wget -q ${{ matrix.pluginval_url }} -O pluginval.zip
          unzip -q pluginval.zip
          chmod +x pluginval

      - name: Download pluginval (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "${{ matrix.pluginval_url }}" -OutFile pluginval.zip
          Expand-Archive -Path pluginval.zip -DestinationPath .

      - name: Download pluginval (macOS)
        if: runner.os == 'macOS'
        run: |
          curl -sL ${{ matrix.pluginval_url }} -o pluginval.zip
          unzip -q pluginval.zip

      - name: Download clap-validator (Linux)
        if: runner.os == 'Linux'
        run: |
          wget -q ${{ matrix.clap_validator_url }} -O clap-validator.tar.gz
          tar -xzf clap-validator.tar.gz
          chmod +x clap-validator

      - name: Download clap-validator (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "${{ matrix.clap_validator_url }}" -OutFile clap-validator.zip
          Expand-Archive -Path clap-validator.zip -DestinationPath .

      - name: Download clap-validator (macOS)
        if: runner.os == 'macOS'
        run: |
          curl -sL ${{ matrix.clap_validator_url }} -o clap-validator.tar.gz
          tar -xzf clap-validator.tar.gz
          chmod +x clap-validator

      - name: Validate VST3 (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "=== VST3 Validation (Strictness Level $VALIDATION_STRICTNESS) ==="
          ./pluginval --validate-in-process --strictness-level $VALIDATION_STRICTNESS target/bundled/Ultrawave.vst3 2>&1 | tee vst3-validation.log
          echo "VST3 validation passed ✅"

      - name: Validate VST3 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== VST3 Validation (Strictness Level $env:VALIDATION_STRICTNESS) ==="
          .\pluginval.exe --validate-in-process --strictness-level $env:VALIDATION_STRICTNESS target\bundled\Ultrawave.vst3 2>&1 | Tee-Object -FilePath vst3-validation.log
          if ($LASTEXITCODE -ne 0) { throw "VST3 validation failed" }
          Write-Host "VST3 validation passed ✅"

      - name: Validate VST3 (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== VST3 Validation (Strictness Level $VALIDATION_STRICTNESS) ==="
          ./pluginval.app/Contents/MacOS/pluginval --validate-in-process --strictness-level $VALIDATION_STRICTNESS target/bundled/Ultrawave.vst3 2>&1 | tee vst3-validation.log
          echo "VST3 validation passed ✅"

      - name: Validate AU (macOS only)
        if: runner.os == 'macOS'
        run: |
          if [ -d "target/bundled/Ultrawave.component" ]; then
            echo "=== AU Validation (Strictness Level $VALIDATION_STRICTNESS) ==="
            ./pluginval.app/Contents/MacOS/pluginval --validate-in-process --strictness-level $VALIDATION_STRICTNESS target/bundled/Ultrawave.component 2>&1 | tee au-validation.log
            echo "AU validation passed ✅"
          else
            echo "AU component not found, skipping AU validation"
          fi

      - name: Validate CLAP (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "=== CLAP Validation ==="
          ./clap-validator validate target/bundled/Ultrawave.clap 2>&1 | tee clap-validation.log
          echo "CLAP validation passed ✅"

      - name: Validate CLAP (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== CLAP Validation ==="
          .\clap-validator.exe validate target\bundled\Ultrawave.clap 2>&1 | Tee-Object -FilePath clap-validation.log
          if ($LASTEXITCODE -ne 0) { throw "CLAP validation failed" }
          Write-Host "CLAP validation passed ✅"

      - name: Validate CLAP (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "=== CLAP Validation ==="
          ./clap-validator validate target/bundled/Ultrawave.clap 2>&1 | tee clap-validation.log
          echo "CLAP validation passed ✅"

      # === GENERATE VALIDATION REPORT ===
      - name: Generate validation report
        id: report
        shell: bash
        run: |
          echo "# Validation Report - ${{ steps.version.outputs.version }}" > validation-report.md
          echo "" >> validation-report.md
          echo "**Platform**: ${{ matrix.os }}" >> validation-report.md
          echo "**Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> validation-report.md
          echo "**Strictness Level**: $VALIDATION_STRICTNESS" >> validation-report.md
          echo "" >> validation-report.md
          echo "## Results" >> validation-report.md
          echo "" >> validation-report.md
          echo "| Format | Status |" >> validation-report.md
          echo "|--------|--------|" >> validation-report.md
          echo "| VST3 | ✅ Passed |" >> validation-report.md
          if [ -f "au-validation.log" ]; then
            echo "| AU | ✅ Passed |" >> validation-report.md
          fi
          echo "| CLAP | ✅ Passed |" >> validation-report.md
          echo "" >> validation-report.md
          echo "---" >> validation-report.md
          echo "✅ **Verified by pluginval** (Strictness Level $VALIDATION_STRICTNESS)" >> validation-report.md
          echo "✅ **Verified by clap-validator**" >> validation-report.md
          cat validation-report.md

      # === PACKAGE ARTIFACTS ===
      - name: Package plugins (Linux)
        if: runner.os == 'Linux'
        run: |
          cd target/bundled
          tar -czvf ../../ultrawave-${{ steps.version.outputs.version }}-linux.tar.gz .

      - name: Package plugins (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path target\bundled\* -DestinationPath ultrawave-${{ steps.version.outputs.version }}-windows.zip

      - name: Package plugins (macOS)
        if: runner.os == 'macOS'
        run: |
          cd target/bundled
          zip -r ../../ultrawave-${{ steps.version.outputs.version }}-macos.zip .

      - name: Upload validation logs
        uses: actions/upload-artifact@v4
        with:
          name: validation-logs-${{ matrix.target }}
          path: |
            *-validation.log
            validation-report.md
          retention-days: 90

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ultrawave-${{ matrix.target }}
          path: |
            ultrawave-*.tar.gz
            ultrawave-*.zip
          retention-days: 90

  create-release:
    name: Create Release
    needs: validate-and-build
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          cp artifacts/ultrawave-linux/*.tar.gz release-files/ || true
          cp artifacts/ultrawave-windows/*.zip release-files/ || true
          cp artifacts/ultrawave-macos/*.zip release-files/ || true

      - name: Combine validation reports
        run: |
          echo "# Ultrawave ${{ needs.validate-and-build.outputs.version }} - Validation Report" > release-files/VALIDATION_REPORT.md
          echo "" >> release-files/VALIDATION_REPORT.md
          echo "All plugins have passed validation testing at strictness level ${{ env.VALIDATION_STRICTNESS }}." >> release-files/VALIDATION_REPORT.md
          echo "" >> release-files/VALIDATION_REPORT.md
          echo "## Platform Results" >> release-files/VALIDATION_REPORT.md
          echo "" >> release-files/VALIDATION_REPORT.md
          for platform in linux windows macos; do
            if [ -f "artifacts/validation-logs-$platform/validation-report.md" ]; then
              echo "### ${platform^}" >> release-files/VALIDATION_REPORT.md
              cat "artifacts/validation-logs-$platform/validation-report.md" >> release-files/VALIDATION_REPORT.md
              echo "" >> release-files/VALIDATION_REPORT.md
            fi
          done
          echo "---" >> release-files/VALIDATION_REPORT.md
          echo "" >> release-files/VALIDATION_REPORT.md
          echo "![Verified by pluginval](https://img.shields.io/badge/Verified%20by-pluginval-blue)" >> release-files/VALIDATION_REPORT.md
          echo "![Verified by clap-validator](https://img.shields.io/badge/Verified%20by-clap--validator-green)" >> release-files/VALIDATION_REPORT.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-and-build.outputs.version }}
          name: Ultrawave ${{ needs.validate-and-build.outputs.version }}
          draft: false
          prerelease: ${{ contains(needs.validate-and-build.outputs.version, '-') }}
          body_path: release-files/VALIDATION_REPORT.md
          files: |
            release-files/ultrawave-*.tar.gz
            release-files/ultrawave-*.zip
            release-files/VALIDATION_REPORT.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload combined validation report
        uses: actions/upload-artifact@v4
        with:
          name: release-validation-report
          path: release-files/VALIDATION_REPORT.md
          retention-days: 365
